@startuml

title View List Rooms Sequence Diagram

actor "User" as Client
boundary "c:RoomController" as Controller
control "s:RoomService" as Service
database "Database" as DB

== View List Rooms ==

Client -> Controller: GET /GetAllRooms (SearchRoomVM)
activate Controller

alt User not authenticated
    Controller -> Controller: Log unauthorized access attempt
    Controller --> Client: 401 Unauthorized { message: "User not authenticated" }
    deactivate Controller
else User authenticated
    Controller -> Service: GetAllRooms(search)
    activate Service

    Service -> DB: Check user role and permissions (UserId, RoleId)
    activate DB
    alt User is not allowed
        DB --> Service: Not found or invalid role
        deactivate DB
        Service -> Service: Log authorization failure
        Service --> Controller: ("You do not have permission to view rooms.", null)
        deactivate Service
        Controller --> Client: 403 Forbidden { success: false, message }
        deactivate Controller
    else User is allowed
        DB --> Service: User role confirmed
        deactivate DB

        Service -> DB: Query Rooms (include Class, Subject, RoomUsers, User)
        activate DB
        DB --> Service: IQueryable<Room>
        deactivate DB

        Service -> Service: Apply filters (ClassId, SubjectId, IsActive, TextSearch)
        Service -> Service: Count total, calculate totalPages
        Service -> DB: Get paged RoomVMs
        activate DB
        DB --> Service: List<RoomVM>
        deactivate DB

        alt No rooms found
            Service --> Controller: ("No rooms found.", null)
            deactivate Service
            Controller --> Client: 400 BadRequest { success: false, message }
            deactivate Controller
        else Rooms found
            Service -> Service: Wrap in SearchResult
            Service --> Controller: ("", SearchResult)
            deactivate Service
            Controller -> Controller: Log successful access
            Controller --> Client: 200 OK { success: true, message, data }
            deactivate Controller
        end alt
    end
end

@enduml 