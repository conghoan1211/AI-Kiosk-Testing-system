@startuml

title View Result Report Sequence Diagram

actor "Lecturer" as Client
boundary "c:ExamController" as Controller
control "s:ExamService" as Service
database "Database" as DB

== View Result Report ==

Client -> Controller: GET /view-result-report/{examId}
activate Controller

alt User not authenticated
    Controller -> Controller: Log unauthorized access attempt
    Controller --> Client: 401 Unauthorized { message: "User not authenticated" }
    deactivate Controller
else User authenticated
    Controller -> Service: ViewResultReport(examId)
    activate Service

    Service -> DB: Check user role and permissions (UserId, RoleId)
    activate DB
    alt User is not teacher
        DB --> Service: Not found or invalid role
        deactivate DB
        Service -> Service: Log authorization failure
        Service --> Controller: ("You do not have permission to view result reports.", null)
        deactivate Service
        Controller --> Client: 403 Forbidden { success: false, message }
        deactivate Controller
    else User is teacher
        DB --> Service: User role confirmed
        deactivate DB

        Service -> DB: Get StudentExams by ExamId (include Student)
        activate DB
        DB --> Service: List<StudentExam> (with Student)
        deactivate DB

        Service -> Service: Map to List<ResultReportVM>
        Service --> Controller: ("", List<ResultReportVM>)
        deactivate Service
        
        alt message.Length > 0
            Controller --> Client: 400 Bad Request { success: false, message }
        else
            Controller -> Controller: Log successful access
            Controller --> Client: 200 OK { success: true, data }
        end
    end
end

deactivate Controller

@enduml 